---

- name: Create {{ user }} user
  user: name={{ user }} shell=/bin/bash groups=sudo,users

- name: Add ssh key to {{ user }} user
  authorized_key: user={{ user }} key={{ lookup('file', '~/.ssh/id_rsa.pub') }}
  when: not ansible_check_mode

- name: Add {{ user }} to sudoers
  template: src=templates/sudoers.j2 dest=/etc/sudoers.d/{{ user }}-sudoer validate='visudo -cf %s'

- name: Disallow root login
  replace: dest=/etc/ssh/sshd_config regexp='^PermitRootLogin yes$' replace='PermitRootLogin no' backup=yes
  when: disallow_root_login

- name: Reload sshd service
  systemd: state=reloaded daemon_reload=yes name=sshd
  when: disallow_root_login

- name: Add dotfiles
  git: repo=https://github.com/ston3o/dotfiles dest=/home/{{ user }}/.dotfiles update=n
  become_user: "{{ user }}"
  become: true

- name: Add tmux.conf
  file: src=/home/{{ user }}/.dotfiles/{{ item }} dest=/home/{{ user }}/{{ item }} state=link
  become_user: "{{ user }}"
  become: true
  with_items:
      - .tmux.conf
      - .tmux
